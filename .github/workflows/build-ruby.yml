name: Build Fully Standalone Ruby 3.2.3

on:
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: macos-15-intel
            arch: x86_64
          - os: macos-latest
            arch: arm64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Build Dependencies
        run: |
          brew install openssl@3 readline libyaml gmp ruby-build
          echo "BREW_PREFIX=$(brew --prefix)" >> $GITHUB_ENV

      - name: Build Ruby 3.2.3
        run: |
          # 必须使用绝对路径进行编译
          export PREFIX="$(pwd)/ruby-dist"
          export CONFIGURE_OPTS="--enable-load-relative \
                                 --disable-install-doc \
                                 --with-openssl-dir=$(brew --prefix openssl@3) \
                                 --with-readline-dir=$(brew --prefix readline) \
                                 --with-libyaml-dir=$(brew --prefix libyaml) \
                                 --with-gmp-dir=$(brew --prefix gmp)"
          ruby-build 3.2.3 $PREFIX

      - name: Bundle All Dependencies and Relocate
        run: |
          PREFIX="$(pwd)/ruby-dist"
          LIB_DEST="$PREFIX/lib"
          BREW_PATH="${{ env.BREW_PREFIX }}"

          echo "--- 1. 收集所有非系统依赖库 ---"
          # 定义需要收集的核心依赖
          LIBS=("libssl.3.dylib" "libcrypto.3.dylib" "libreadline.8.dylib" "libyaml-0.2.dylib" "libgmp.10.dylib")
          
          for lib in "${LIBS[@]}"; do
            LIB_SRC=$(find $BREW_PATH/lib -name "$lib" -type f | head -n 1)
            if [ -f "$LIB_SRC" ]; then
              cp "$LIB_SRC" "$LIB_DEST/"
              chmod 755 "$LIB_DEST/$lib"
              echo "✅ Bundled: $lib"
            else
              echo "❌ Warning: Could not find $lib"
            fi
          done

          echo "--- 2. 定义路径修复逻辑 ---"
          # 修复 Mach-O 文件的函数
          fix_links() {
            local file=$1
            local target_rel_path=$2
            
            # 这里的正则匹配 /opt/homebrew (ARM) 和 /usr/local (Intel) 以及 Cellar 路径
            otool -L "$file" | grep -E "/opt/homebrew|/usr/local|${{ env.BREW_PREFIX }}" | awk '{print $1}' | while read old_path; do
              # 排除系统库（虽然正则已经过滤，但做个保险）
              if [[ "$old_path" == /usr/lib/* ]] || [[ "$old_path" == /System/* ]]; then continue; fi
              
              lib_name=$(basename "$old_path")
              echo "   Fixing $lib_name in $(basename "$file")"
              install_name_tool -change "$old_path" "$target_rel_path/$lib_name" "$file"
            done
          }

          echo "--- 3. 递归处理所有二进制文件 ---"
          
          # A. 修复 lib 下的 dylib 相互引用 (使用 @loader_path)
          for dylib in "$LIB_DEST"/*.dylib; do
            [ -e "$dylib" ] || continue
            install_name_tool -id "@rpath/$(basename "$dylib")" "$dylib"
            fix_links "$dylib" "@loader_path"
          done

          # B. 修复 Ruby 主程序 (使用 @executable_path)
          fix_links "$PREFIX/bin/ruby" "@executable_path/../lib"

          # C. 修复所有扩展模块 .bundle (使用动态相对路径)
          find "$LIB_DEST/ruby" -name "*.bundle" | while read bundle; do
            chmod 755 "$bundle"
            # 计算 bundle 到 lib 根目录的层级关系
            REL_TO_LIB=$(python3 -c "import os; print(os.path.relpath('$LIB_DEST', os.path.dirname('$bundle')))")
            fix_links "$bundle" "@loader_path/$REL_TO_LIB"
          done

      - name: Sanity Check
        run: |
          echo "Checking for any remaining hardcoded Brew paths..."
          # 如果输出为空则说明修复彻底
          otool -L ./ruby-dist/bin/ruby | grep "${{ env.BREW_PREFIX }}" || echo "Ruby Binary Clean!"
          
          echo "Testing Ruby execution..."
          ./ruby-dist/bin/ruby -v
          ./ruby-dist/bin/ruby -ropenssl -ryaml -e "puts 'All dependencies loaded successfully!'"

      - name: Package and Upload
        run: |
          # 移除开发冗余文件
          rm -rf ruby-dist/include ruby-dist/lib/pkgconfig
          find ruby-dist/lib -name "*.a" -delete
          
          OUTPUT_FILE="ruby-3.2.3-standalone-${{ matrix.arch }}.tar.gz"
          tar -czvf $OUTPUT_FILE ruby-dist
          echo "OUTPUT_FILE=$OUTPUT_FILE" >> $GITHUB_ENV

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ruby-3.2.3-macos-15-${{ matrix.arch }}
          path: ${{ env.OUTPUT_FILE }}
