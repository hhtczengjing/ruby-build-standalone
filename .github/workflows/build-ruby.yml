name: Build Fully Standalone Ruby 3.2.3

on:
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-15-intel
            arch: x86_64
          - os: macos-latest
            arch: arm64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Build Dependencies
        run: |
          brew install openssl@3 readline libyaml gmp ruby-build
          echo "BREW_PREFIX=$(brew --prefix)" >> $GITHUB_ENV

      - name: Build Ruby 3.2.3
        run: |
          PREFIX="$(pwd)/ruby-dist"
          mkdir -p "$PREFIX"
          
          # 配置参数优化：启用共享库并确保路径相对化
          export CONFIGURE_OPTS="--enable-load-relative \
                                 --enable-shared \
                                 --disable-install-doc \
                                 --with-openssl-dir=$(brew --prefix openssl@3) \
                                 --with-readline-dir=$(brew --prefix readline) \
                                 --with-libyaml-dir=$(brew --prefix libyaml) \
                                 --with-gmp-dir=$(brew --prefix gmp)"
          
          # macos-15-intel 建议限制并发以保证稳定性
          export MAKE_OPTS="-j2"
          ruby-build 3.2.3 "$PREFIX"

      - name: Bundle Dependencies and Fix Mach-O
        run: |
          PREFIX="$(pwd)/ruby-dist"
          LIB_DEST="$PREFIX/lib"
          BREW_PATH="${{ env.BREW_PREFIX }}"

          echo "--- 1. 拷贝依赖库 ---"
          LIBS=("libssl.3.dylib" "libcrypto.3.dylib" "libreadline.8.dylib" "libyaml-0.2.dylib" "libgmp.10.dylib")
          for lib in "${LIBS[@]}"; do
            LIB_SRC=$(find "$BREW_PATH/lib" -name "$lib" -type f | head -n 1)
            if [ -n "$LIB_SRC" ]; then
              cp "$LIB_SRC" "$LIB_DEST/"
              chmod 755 "$LIB_DEST/$lib"
              echo "✅ 已打包: $lib"
            fi
          done

          echo "--- 2. 规范化库标识 (LC_ID_DYLIB) ---"
          for dylib in "$LIB_DEST"/*.dylib; do
            [ -e "$dylib" ] || continue
            libname=$(basename "$dylib")
            # 将库自身的 ID 定义为 @rpath 模式
            install_name_tool -id "@rpath/$libname" "$dylib"
            
            # 修复库与库之间的依赖 (如 libssl 依赖 libcrypto)
            otool -L "$dylib" | grep -E "/opt/homebrew|/usr/local|Cellar" | awk '{print $1}' | while read -r old_path; do
              [ -z "$old_path" ] && continue
              install_name_tool -change "$old_path" "@rpath/$(basename "$old_path")" "$dylib"
            done
          done

          echo "--- 3. 递归修复 RPATH 搜索路径 ---"
          # 遍历所有二进制文件 (ruby 主程序, .bundle 扩展, .dylib 库)
          find "$PREFIX" -type f \( -perm +111 -o -name "*.bundle" -o -name "*.dylib" \) | while read -r bin; do
            if file "$bin" | grep -q "Mach-O"; then
              chmod +w "$bin"
              
              # A. 将硬编码的外部库路径改为 @rpath 引用
              otool -L "$bin" | grep -E "/opt/homebrew|/usr/local|Cellar" | awk '{print $1}' | while read -r old_path; do
                [ -z "$old_path" ] && continue
                install_name_tool -change "$old_path" "@rpath/$(basename "$old_path")" "$bin"
              done

              # B. 注入多级搜寻路径 (RPATH)
              # 针对 bin/ruby: 向上跳一级到 lib
              install_name_tool -add_rpath "@executable_path/../lib" "$bin" 2>/dev/null || true
              # 针对 .bundle 扩展: 根据不同深度注入多种跳转方案，确保万无一失
              # 路径 lib/ruby/3.2.0/arm64-darwin24/ 需要向上跳 3 级到达 lib/
              install_name_tool -add_rpath "@loader_path/../../../" "$bin" 2>/dev/null || true
              install_name_tool -add_rpath "@loader_path/../../../../" "$bin" 2>/dev/null || true
              install_name_tool -add_rpath "@loader_path/../../" "$bin" 2>/dev/null || true
              install_name_tool -add_rpath "@loader_path/../" "$bin" 2>/dev/null || true
              # 备选：在 Actions 验证阶段注入绝对路径
              install_name_tool -add_rpath "$LIB_DEST" "$bin" 2>/dev/null || true
            fi
          done

      - name: Verify Execution
        run: |
          echo "Checking Ruby environment..."
          ./ruby-dist/bin/ruby -v
          # 验证是否能成功加载 openssl 和 yaml 扩展
          ./ruby-dist/bin/ruby -ropenssl -ryaml -e "puts '✅ Ruby 独立运行环境验证成功，所有依赖库已加载。'"

      - name: Package Artifact
        run: |
          # 移除不必要的开发头文件和静态库以减小体积
          rm -rf ruby-dist/include ruby-dist/lib/pkgconfig
          find ruby-dist/lib -name "*.a" -delete
          
          OUTPUT="ruby-3.2.3-standalone-${{ matrix.arch }}.tar.gz"
          tar -czvf "$OUTPUT" ruby-dist
          echo "FILENAME=$OUTPUT" >> $GITHUB_ENV

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ruby-3.2.3-macos-15-${{ matrix.arch }}
          path: ${{ env.FILENAME }}
