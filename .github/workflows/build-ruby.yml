name: Build Fully Standalone Ruby 3.2.3

on:
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: macos-15-intel
            arch: x86_64
          - os: macos-latest
            arch: arm64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Build Dependencies
        run: |
          brew install openssl@3 readline libyaml gmp ruby-build
          echo "BREW_PREFIX=$(brew --prefix)" >> $GITHUB_ENV

      - name: Build Ruby 3.2.3
        run: |
          # 必须使用绝对路径进行编译
          export PREFIX="$(pwd)/ruby-dist"
          export CONFIGURE_OPTS="--enable-load-relative \
                                 --disable-install-doc \
                                 --with-openssl-dir=$(brew --prefix openssl@3) \
                                 --with-readline-dir=$(brew --prefix readline) \
                                 --with-libyaml-dir=$(brew --prefix libyaml) \
                                 --with-gmp-dir=$(brew --prefix gmp)"
          ruby-build 3.2.3 $PREFIX

      - name: Bundle All Dependencies and Relocate
        run: |
          PREFIX="$(pwd)/ruby-dist"
          LIB_DEST="$PREFIX/lib"
          BREW_PATH="${{ env.BREW_PREFIX }}"

          echo "--- 1. 收集依赖库 ---"
          LIBS=("libssl.3.dylib" "libcrypto.3.dylib" "libreadline.8.dylib" "libyaml-0.2.dylib" "libgmp.10.dylib")
          for lib in "${LIBS[@]}"; do
            LIB_SRC=$(find $BREW_PATH/lib -name "$lib" -type f | head -n 1)
            [ -f "$LIB_SRC" ] && cp "$LIB_SRC" "$LIB_DEST/" && chmod 755 "$LIB_DEST/$lib"
          done

          echo "--- 2. 修复库文件自身的 ID 和相互引用 ---"
          for dylib in "$LIB_DEST"/*.dylib; do
            [ -e "$dylib" ] || continue
            # 将 ID 改为 @rpath 名称
            install_name_tool -id "@rpath/$(basename "$dylib")" "$dylib"
            
            # 修复 dylib 之间的引用 (比如 libssl 找 libcrypto)
            # 使用 @loader_path 确保它们在同一目录下能互相找到
            otool -L "$dylib" | grep -E "/opt/homebrew|/usr/local" | awk '{print $1}' | while read old_path; do
              install_name_tool -change "$old_path" "@loader_path/$(basename "$old_path")" "$dylib"
            done
          done

          echo "--- 3. 修复 Ruby 扩展模块 (*.bundle) ---"
          # 这一步最关键：我们不再依赖复杂的相对路径计算，而是直接使用更稳健的深度搜索
          find "$LIB_DEST/ruby" -name "*.bundle" | while read bundle; do
            chmod 755 "$bundle"
            
            # 获取当前 bundle 所在目录的深度（相对于 PREFIX 的深度）
            # 例如 lib/ruby/3.2.0/arm64-darwin24 深度为 4
            # 我们需要跳 4 次回根目录，再进 lib
            # 但更简单的方法是：直接跳到顶级 lib
            
            otool -L "$bundle" | grep -E "/opt/homebrew|/usr/local" | awk '{print $1}' | while read old_path; do
              lib_name=$(basename "$old_path")
              
              # 重点：Ruby 3.2.3 的架构相关 bundle 在 lib/ruby/3.2.0/arm64-darwin24/ 目录下
              # 从该目录到 lib/ 目录需要向上跳 4 级：../../../../
              # 我们改用硬编码跳转确保成功
              install_name_tool -change "$old_path" "@loader_path/../../../../$lib_name" "$bundle"
            done
          done

          echo "--- 4. 修复 Ruby 主程序 ---"
          # 从 bin/ruby 到 lib/ 只需要跳 1 级
          otool -L "$PREFIX/bin/ruby" | grep -E "/opt/homebrew|/usr/local" | awk '{print $1}' | while read old_path; do
            install_name_tool -change "$old_path" "@executable_path/../lib/$(basename "$old_path")" "$PREFIX/bin/ruby"
          done

      - name: Sanity Check
        run: |
          echo "Checking for any remaining hardcoded Brew paths..."
          # 如果输出为空则说明修复彻底
          otool -L ./ruby-dist/bin/ruby | grep "${{ env.BREW_PREFIX }}" || echo "Ruby Binary Clean!"
          
          echo "Testing Ruby execution..."
          ./ruby-dist/bin/ruby -v
          ./ruby-dist/bin/ruby -ropenssl -ryaml -e "puts 'All dependencies loaded successfully!'"

      - name: Package and Upload
        run: |
          # 移除开发冗余文件
          rm -rf ruby-dist/include ruby-dist/lib/pkgconfig
          find ruby-dist/lib -name "*.a" -delete
          
          OUTPUT_FILE="ruby-3.2.3-standalone-${{ matrix.arch }}.tar.gz"
          tar -czvf $OUTPUT_FILE ruby-dist
          echo "OUTPUT_FILE=$OUTPUT_FILE" >> $GITHUB_ENV

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ruby-3.2.3-macos-15-${{ matrix.arch }}
          path: ${{ env.OUTPUT_FILE }}
