name: Build Fully Standalone Ruby 3.2.3

on:
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-15-intel
            arch: x86_64
          - os: macos-latest
            arch: arm64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Build Dependencies
        run: |
          # 显式安装依赖，确保编译环境干净
          brew install openssl@3 readline libyaml gmp ruby-build
          echo "BREW_PREFIX=$(brew --prefix)" >> $GITHUB_ENV

      - name: Build Ruby 3.2.3
        run: |
          export PREFIX="$(pwd)/ruby-dist"
          
          # 精简后的配置参数，避免重复
          # 增加 --enable-shared 确保生成 .dylib，便于路径修复
          export CONFIGURE_OPTS="--enable-load-relative \
                                 --enable-shared \
                                 --disable-install-doc \
                                 --with-openssl-dir=$(brew --prefix openssl@3) \
                                 --with-readline-dir=$(brew --prefix readline) \
                                 --with-libyaml-dir=$(brew --prefix libyaml) \
                                 --with-gmp-dir=$(brew --prefix gmp)"
          
          # 限制并发数为 2，防止内存溢出导致任务取消 (Operation Canceled)
          export MAKE_OPTS="-j2"
          
          ruby-build 3.2.3 $PREFIX

      - name: Bundle Dependencies and Fix Mach-O (RPATH Strategy)
        run: |
          PREFIX="$(pwd)/ruby-dist"
          LIB_DEST="$PREFIX/lib"
          BREW_PATH="${{ env.BREW_PREFIX }}"

          echo "--- 1. 拷贝依赖库 ---"
          LIBS=("libssl.3.dylib" "libcrypto.3.dylib" "libreadline.8.dylib" "libyaml-0.2.dylib" "libgmp.10.dylib")
          for lib in "${LIBS[@]}"; do
            LIB_SRC=$(find $BREW_PATH/lib -name "$lib" -type f | head -n 1)
            if [ -f "$LIB_SRC" ]; then
              cp "$LIB_SRC" "$
